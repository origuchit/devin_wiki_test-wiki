name: Wikiãƒªãƒã‚¸ãƒˆãƒªã¸ã®åŒæœŸï¼ˆå±¥æ­´ã‚¯ãƒªãƒ¼ãƒ³ï¼‰

on:
  schedule:
    # æ¯æ—¥ æ—¥æœ¬æ™‚é–“ 12:00 (UTC 03:00) ã«å®Ÿè¡Œ
    - cron: '0 3 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œç”¨ãƒœã‚¿ãƒ³

jobs:
  sync-clean-push:
    runs-on: ubuntu-latest
    steps:
      # 1. ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®å–å¾—ï¼ˆå…¨å±¥æ­´ï¼‰
      - name: Checkout source (Mirror)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. ã™ã¹ã¦ã®ãƒ–ãƒ©ãƒ³ãƒã¨ã‚¿ã‚°ã‚’å–å¾—
      - name: Fetch all branches and tags
        run: |
          git fetch --all --tags
          echo "âœ… ã™ã¹ã¦ã®ãƒ–ãƒ©ãƒ³ãƒã¨ã‚¿ã‚°ã‚’å–å¾—ã—ã¾ã—ãŸ"

      # 3. ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ©ãƒ³ãƒã¨ã—ã¦ä½œæˆï¼ˆmaster/release/developã‚’å«ã‚€ãƒ–ãƒ©ãƒ³ãƒã®ã¿ã€æ—¥ä»˜ä»˜ãã¯æœ€æ–°ã®ã¿ï¼‰
      - name: Create local branches from remote branches
        run: |
          echo "ğŸ“‹ ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ©ãƒ³ãƒã¨ã—ã¦ä½œæˆä¸­..."
          echo "   â€» masterã€releaseã€developã‚’å«ã‚€ãƒ–ãƒ©ãƒ³ãƒã®ã¿ã‚’å¯¾è±¡ã¨ã—ã¾ã™"
          echo "   â€» æ—¥ä»˜ä»˜ããƒ–ãƒ©ãƒ³ãƒï¼ˆä¾‹: develop/r20240326ï¼‰ã¯æœ€æ–°ã‹ã‚‰2ã¤ã‚’å–å¾—ã—ã¾ã™"
          
          # ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—ï¼ˆorigin/ã‚’é™¤ãï¼‰
          ALL_BRANCHES=$(git branch -r | grep -v 'origin/HEAD' | sed 's|origin/||' | \
            grep -E '(master|release|develop|main)')
          
          # æ—¥ä»˜ãªã—ã®ãƒ–ãƒ©ãƒ³ãƒï¼ˆmasterã€developã€releaseã€mainï¼‰ã‚’å–å¾—
          BASE_BRANCHES=$(echo "$ALL_BRANCHES" | grep -vE '/(develop|release)/r[0-9]' | grep -E '(master|develop|release|main)$' || true)
          
          # æ—¥ä»˜ä»˜ããƒ–ãƒ©ãƒ³ãƒã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦æœ€æ–°ã‹ã‚‰2ã¤ã‚’å–å¾—
          # develop / release ã‚’å«ã¿ã€ãƒ–ãƒ©ãƒ³ãƒåå†…ã«æ—¥ä»˜(YYYYMMDD)ãŒå«ã¾ã‚Œã‚‹ã‚‚ã®ã‚’å¯¾è±¡
          # ä¾‹: develop/r20240326, develop/20240326_xxx, release/fix_2024/12/24_release ç­‰
          LATEST_DATED_BRANCHES=""
          DATED_BRANCHES=$(echo "$ALL_BRANCHES" | grep -E '(develop|release)' || true)
          if [ -n "$DATED_BRANCHES" ]; then
            # ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ï¼ˆä¸Šä½5ä»¶ï¼‰
            echo "ğŸ“… æ¤œå‡ºã•ã‚ŒãŸ develop/release ã‚’å«ã‚€ãƒ–ãƒ©ãƒ³ãƒä¾‹:"
            echo "$DATED_BRANCHES" | head -5 | sed 's/^/  - /'
            echo ""
            
            LATEST_DATED_BRANCHES=$(echo "$DATED_BRANCHES" | \
              awk -F'/' '
              {
                branch = $0
                # develop ã¾ãŸã¯ release ã‚’å«ã‚€ã‚‚ã®ã ã‘å¯¾è±¡
                if (index(branch, "develop") == 0 && index(branch, "release") == 0) next
                
                # ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã¯å…ˆé ­ã‚»ã‚°ãƒ¡ãƒ³ãƒˆï¼ˆæ¡ˆä»¶åæƒ³å®šï¼‰
                prefix = $1
                
                # ãƒ–ãƒ©ãƒ³ãƒåã‹ã‚‰æ•°å­—ã ã‘ã‚’æŠ½å‡ºã—ã€å…ˆé ­8æ¡ã‚’æ—¥ä»˜å€™è£œã¨ã—ã¦æ‰±ã†
                digits = branch
                gsub(/[^0-9]/, "", digits)
                if (length(digits) < 8) next
                date = substr(digits, 1, 8)
                
                # YYYYMMDD ã®å½¢å¼ã‹ã¤ 20xx å¹´ã«é™å®š
                if (date !~ /^20[0-9]{6}$/) next
                
                # ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã”ã¨ã«æ—¥ä»˜->ãƒ–ãƒ©ãƒ³ãƒåã‚’ä¿æŒ
                branches[prefix, date] = branch
                dates[prefix] = dates[prefix] " " date
              }
              END {
                for (p in dates) {
                  split(dates[p], arr, " ")
                  n = asort(arr)
                  count = 0
                  for (i = n; i >= 1 && count < 2; i--) {
                    d = arr[i]
                    if (d == "") continue
                    print branches[p, d]
                    count++
                  }
                }
              }')
          fi
          
          # ã™ã¹ã¦ã®å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒã‚’çµåˆ
          TARGET_BRANCHES=$(echo -e "$BASE_BRANCHES\n$LATEST_DATED_BRANCHES" | grep -v '^$' | sort -u)
          
          BRANCH_COUNT=$(echo "$TARGET_BRANCHES" | grep -c . || echo "0")
          echo ""
          echo "ğŸ“‹ å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒï¼ˆ${BRANCH_COUNT}å€‹ï¼‰:"
          echo "$TARGET_BRANCHES" | sed 's/^/  - /'
          echo ""
          
          # mainãƒ–ãƒ©ãƒ³ãƒãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
          MAIN_EXISTS=false
          if echo "$TARGET_BRANCHES" | grep -q "^main$"; then
            MAIN_EXISTS=true
          fi
          
          for branch in $(echo "$TARGET_BRANCHES"); do
            # mainãƒ–ãƒ©ãƒ³ãƒã¯æ—¢ã«å­˜åœ¨ã™ã‚‹ã®ã§ã‚¹ã‚­ãƒƒãƒ—
            if [ "$branch" != "main" ]; then
              echo "  ä½œæˆä¸­: $branch"
              git checkout -b "$branch" "origin/$branch" 2>/dev/null || echo "    (æ—¢ã«å­˜åœ¨ã¾ãŸã¯ä½œæˆæ¸ˆã¿)"
            fi
          done
          
          # mainãƒ–ãƒ©ãƒ³ãƒã«æˆ»ã‚‹ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
          if [ "$MAIN_EXISTS" = true ]; then
            git checkout main 2>/dev/null || echo "âš ï¸  mainãƒ–ãƒ©ãƒ³ãƒã¸ã®åˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸ"
          else
            # mainãƒ–ãƒ©ãƒ³ãƒãŒå­˜åœ¨ã—ãªã„å ´åˆã€æœ€åˆã®ãƒ–ãƒ©ãƒ³ãƒã«æˆ»ã‚‹
            FIRST_BRANCH=$(echo "$TARGET_BRANCHES" | head -1)
            if [ -n "$FIRST_BRANCH" ]; then
              echo "âš ï¸  mainãƒ–ãƒ©ãƒ³ãƒãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€æœ€åˆã®ãƒ–ãƒ©ãƒ³ãƒï¼ˆ$FIRST_BRANCHï¼‰ã«æˆ»ã‚Šã¾ã™"
              git checkout "$FIRST_BRANCH" 2>/dev/null || echo "âš ï¸  ãƒ–ãƒ©ãƒ³ãƒã¸ã®åˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸ"
            fi
          fi
          
          echo ""
          echo "ğŸ“‹ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ©ãƒ³ãƒä¸€è¦§:"
          git branch --list
          echo ""
          echo "âœ… å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä½œæˆã—ã¾ã—ãŸ"

      # ã€å®‰å…¨å¯¾ç­–Aã€‘ãƒ¡ã‚¤ãƒ³ãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ¥ç¶šã‚’ç‰©ç†çš„ã«åˆ‡æ–­
      # ã“ã‚Œã«ã‚ˆã‚Šã€ã“ã®å¾Œã®å·¥ç¨‹ã§é–“é•ã£ã¦ãƒ¡ã‚¤ãƒ³å´ã«pushã™ã‚‹ã“ã¨ã¯ä¸å¯èƒ½ã«ãªã‚Šã¾ã™
      - name: ğŸ›¡ï¸ Safety Guard (Remove Origin)
        run: |
          echo "ã‚½ãƒ¼ã‚¹ãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ¥ç¶šã‚’è§£é™¤ã—ã¦ã„ã¾ã™..."
          git remote remove origin
          
          # ç¢ºèª: originãŒæ¶ˆãˆã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git remote | grep -q "^origin$"; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: originã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸï¼"
            exit 1
          fi
          echo "âœ… originã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚å®‰å…¨ã«å‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™ã€‚"

      # 4. ãƒ„ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install git-filter-repo
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip install git-filter-repo
          git-filter-repo --version

      # 5. å±¥æ­´ã®æµ„åŒ–
      - name: Clean History (Remove Secrets)
        run: |
          set -e
          git config --global user.email "action@github.com"
          git config --global user.name "Wiki Sync Action"

          echo "ğŸ§¹ ãƒªãƒã‚¸ãƒˆãƒªã®å±¥æ­´ã‚’ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ä¸­..."
          
          # å‰Šé™¤å‰ã®å±¥æ­´ã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
          echo "ğŸ“‹ å‰Šé™¤å‰ã®å±¥æ­´ã«å«ã¾ã‚Œã‚‹æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«:"
          git log --all --full-history --name-only --pretty=format: | grep -E '(\.env|credentials|secrets|keys|\.pem|\.key|\.p12|auth\.json)' | sort -u | head -20 || echo "  (ãªã—)"

          # --- å‰Šé™¤å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®š ---
          # è¿½åŠ è¦æœ›ã®ã‚ã£ãŸ envç³»ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç¶²ç¾…ã—ã¦ã„ã¾ã™
          git filter-repo \
            --path-glob '.env*' \
            --path-glob 'env.*' \
            --path-glob '.docker.env' \
            --path-glob '.docker.env.example' \
            --path-glob '*.env.example' \
            --path-glob '**/*.pem' \
            --path-glob '*.pem' \
            --path-glob '**/*.key' \
            --path-glob '*.key' \
            --path-glob '**/*.p12' \
            --path-glob '*.p12' \
            --path-glob 'auth.json' \
            --path 'tools/auto-if/hulft/setup/etc/chrony.keys' \
            --path 'tools/provisioning/bootstrapping/aws/cdk/.env.example' \
            --path 'tools/provisioning/orchestration/vendor/bundler/ruby/2.6.0/gems/multi_json-1.15.0/lib/multi_json/convertible_hash_keys.rb' \
            --path-glob '**/*credentials*.json' \
            --path-glob '*credentials*.json' \
            --path-glob '**/*secrets*.json' \
            --path-glob '*secrets*.json' \
            --path-glob '**/*keys*.json' \
            --path-glob '*keys*.json' \
            --path-glob '**/*secret*.json' \
            --path-glob '*secret*.json' \
            --path-glob '**/*password*.json' \
            --path-glob '*password*.json' \
            --path-glob '**/*token*.json' \
            --path-glob '*token*.json' \
            --path '.ssh' \
            --path-glob 'config/secrets.*' \
            --path 'config/remote.php' \
            --path 'storage/logs' \
            --path 'storage/framework' \
            --path 'storage/app/tmp' \
            --path 'storage/app/private' \
            --path 'storage/batch/logs' \
            --invert-paths \
            --force

          echo ""
          echo "ğŸ“‹ å‰Šé™¤å¾Œã®å±¥æ­´ç¢ºèª:"
          echo "   æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ãŒå±¥æ­´ã«æ®‹ã£ã¦ã„ãªã„ã‹ç¢ºèªä¸­..."
          REMAINING=$(git log --all --full-history --name-only --pretty=format: | \
            grep -E '(\.env|credentials|secrets|keys|\.pem|\.key|\.p12|auth\.json)' | \
            grep -v '^\\.github/workflows/verify-secrets\\.yml$' | \
            sort -u || true)
          if [ -n "$REMAINING" ]; then
            echo "âš ï¸  è­¦å‘Š: ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå±¥æ­´ã«æ®‹ã£ã¦ã„ã¾ã™:"
            echo "$REMAINING" | sed 's/^/  - /'
          else
            echo "  âœ… æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ã¯å±¥æ­´ã‹ã‚‰å‰Šé™¤ã•ã‚Œã¾ã—ãŸ"
          fi

          echo "âœ¨ ãƒªãƒã‚¸ãƒˆãƒªã®ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼ˆæ©Ÿå¯†æƒ…å ±å‰Šé™¤ï¼‰ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"

      # 6. SSHã‚­ãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup SSH Key
        env:
          SSH_KEY: ${{ secrets.WIKI_SYNC_SSH_KEY }}
        run: |
          set -e
          if [ -z "$SSH_KEY" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: WIKI_SYNC_SSH_KEY ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 1
          fi
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          echo "âœ… SSHã‚­ãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"

      # 7. Wikiãƒªãƒã‚¸ãƒˆãƒªã¸ã®å¼·åˆ¶ãƒ—ãƒƒã‚·ãƒ¥
      - name: Push to Wiki Repo
        env:
          DEST_REPO: "git@github.com:origuchit/devin_wiki_test-wiki.git"
        run: |
          set -e
          
          # æ—¢å­˜ã®destinationãƒªãƒ¢ãƒ¼ãƒˆãŒã‚ã‚Œã°å‰Šé™¤
          if git remote | grep -q "^destination$"; then
            git remote remove destination
          fi
          
          # ãƒªãƒ¢ãƒ¼ãƒˆè¿½åŠ ï¼ˆoriginã§ã¯ãªãdestinationã¨ã—ã¦è¿½åŠ ï¼‰
          git remote add destination "$DEST_REPO"
          
          # æƒ…å ±è¡¨ç¤º
          echo "ğŸ“¦ Wikiãƒªãƒã‚¸ãƒˆãƒªã¸ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ã„ã¾ã™..."
          echo "   é€ä¿¡å…ˆ: $DEST_REPO"
          echo ""
          echo "ğŸ“‹ ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ãƒ–ãƒ©ãƒ³ãƒ:"
          git branch --list | sed 's/^/  - /'
          echo ""
          echo "ğŸ“‹ ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ã‚¿ã‚°:"
          git tag --list | sed 's/^/  - /' || echo "  (ã‚¿ã‚°ãªã—)"
          echo ""
          
          # Pushå®Ÿè¡Œï¼ˆã™ã¹ã¦ã®ãƒ–ãƒ©ãƒ³ãƒã¨ã‚¿ã‚°ã‚’ãƒ—ãƒƒã‚·ãƒ¥ï¼‰
          # destination ã«ã—ã‹é€ã‚Œãªã„çŠ¶æ…‹ã«ãªã£ã¦ã„ã¾ã™
          git push --mirror --force destination
          
          echo "âœ… Wikiãƒªãƒã‚¸ãƒˆãƒªã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã«æˆåŠŸã—ã¾ã—ãŸ"

