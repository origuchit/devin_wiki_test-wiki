name: Sync to Wiki Repository (Clean History)

on:
  schedule:
    # æ¯æ—¥ æ—¥æœ¬æ™‚é–“ 12:00 (UTC 03:00) ã«å®Ÿè¡Œ
    - cron: '0 3 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œç”¨ãƒœã‚¿ãƒ³

jobs:
  sync-clean-push:
    runs-on: ubuntu-latest
    steps:
      # 1. ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®å–å¾—ï¼ˆå…¨å±¥æ­´ï¼‰
      - name: Checkout source (Mirror)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. ã™ã¹ã¦ã®ãƒ–ãƒ©ãƒ³ãƒã¨ã‚¿ã‚°ã‚’å–å¾—
      - name: Fetch all branches and tags
        run: |
          git fetch --all --tags
          echo "âœ… ã™ã¹ã¦ã®ãƒ–ãƒ©ãƒ³ãƒã¨ã‚¿ã‚°ã‚’å–å¾—ã—ã¾ã—ãŸ"

      # 3. ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ©ãƒ³ãƒã¨ã—ã¦ä½œæˆ
      - name: Create local branches from remote branches
        run: |
          echo "ğŸ“‹ ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ©ãƒ³ãƒã¨ã—ã¦ä½œæˆä¸­..."
          
          # ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—ï¼ˆorigin/ã‚’é™¤ãï¼‰
          REMOTE_BRANCHES=$(git branch -r | grep -v 'origin/HEAD' | sed 's|origin/||' | xargs)
          
          for branch in $REMOTE_BRANCHES; do
            # mainãƒ–ãƒ©ãƒ³ãƒã¯æ—¢ã«å­˜åœ¨ã™ã‚‹ã®ã§ã‚¹ã‚­ãƒƒãƒ—
            if [ "$branch" != "main" ]; then
              echo "  ä½œæˆä¸­: $branch"
              git checkout -b "$branch" "origin/$branch" 2>/dev/null || echo "    (æ—¢ã«å­˜åœ¨ã¾ãŸã¯ä½œæˆæ¸ˆã¿)"
            fi
          done
          
          # mainãƒ–ãƒ©ãƒ³ãƒã«æˆ»ã‚‹
          git checkout main
          
          echo ""
          echo "ğŸ“‹ ãƒ­ãƒ¼ã‚«ãƒ«ãƒ–ãƒ©ãƒ³ãƒä¸€è¦§:"
          git branch --list
          echo ""
          echo "âœ… ã™ã¹ã¦ã®ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä½œæˆã—ã¾ã—ãŸ"

      # ã€å®‰å…¨å¯¾ç­–Aã€‘ãƒ¡ã‚¤ãƒ³ãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ¥ç¶šã‚’ç‰©ç†çš„ã«åˆ‡æ–­
      # ã“ã‚Œã«ã‚ˆã‚Šã€ã“ã®å¾Œã®å·¥ç¨‹ã§é–“é•ã£ã¦ãƒ¡ã‚¤ãƒ³å´ã«pushã™ã‚‹ã“ã¨ã¯ä¸å¯èƒ½ã«ãªã‚Šã¾ã™
      - name: ğŸ›¡ï¸ Safety Guard (Remove Origin)
        run: |
          echo "ã‚½ãƒ¼ã‚¹ãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ¥ç¶šã‚’è§£é™¤ã—ã¦ã„ã¾ã™..."
          git remote remove origin
          
          # ç¢ºèª: originãŒæ¶ˆãˆã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if git remote | grep -q "^origin$"; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: originã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸï¼"
            exit 1
          fi
          echo "âœ… originã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚å®‰å…¨ã«å‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™ã€‚"

      # 4. ãƒ„ãƒ¼ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install git-filter-repo
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          pip install git-filter-repo
          git-filter-repo --version

      # 5. å±¥æ­´ã®æµ„åŒ–
      - name: Clean History (Remove Secrets)
        run: |
          set -e
          git config --global user.email "action@github.com"
          git config --global user.name "Wiki Sync Action"

          echo "ğŸ§¹ ãƒªãƒã‚¸ãƒˆãƒªã®å±¥æ­´ã‚’ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ä¸­..."

          # --- å‰Šé™¤å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®š ---
          # è¿½åŠ è¦æœ›ã®ã‚ã£ãŸ envç³»ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç¶²ç¾…ã—ã¦ã„ã¾ã™
          git filter-repo \
            --path-glob '.env*' \
            --path-glob 'env.*' \
            --path-glob '.docker.env' \
            --path-glob '**/*.pem' \
            --path-glob '**/*.key' \
            --path-glob '**/*.p12' \
            --path-glob 'auth.json' \
            --path '.ssh' \
            --path-glob 'config/secrets.*' \
            --path 'config/remote.php' \
            --path 'storage/logs' \
            --path 'storage/framework' \
            --path 'storage/app/tmp' \
            --path 'storage/app/private' \
            --path 'storage/batch/logs' \
            --invert-paths \
            --force

          echo "âœ¨ ãƒªãƒã‚¸ãƒˆãƒªã®ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼ˆæ©Ÿå¯†æƒ…å ±å‰Šé™¤ï¼‰ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"

      # 6. SSHã‚­ãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup SSH Key
        env:
          SSH_KEY: ${{ secrets.WIKI_SYNC_SSH_KEY }}
        run: |
          set -e
          if [ -z "$SSH_KEY" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: WIKI_SYNC_SSH_KEY ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 1
          fi
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          echo "âœ… SSHã‚­ãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"

      # 7. Wikiãƒªãƒã‚¸ãƒˆãƒªã¸ã®å¼·åˆ¶ãƒ—ãƒƒã‚·ãƒ¥
      - name: Push to Wiki Repo
        env:
          DEST_REPO: "git@github.com:origuchit/devin_wiki_test-wiki.git"
        run: |
          set -e
          
          # æ—¢å­˜ã®destinationãƒªãƒ¢ãƒ¼ãƒˆãŒã‚ã‚Œã°å‰Šé™¤
          if git remote | grep -q "^destination$"; then
            git remote remove destination
          fi
          
          # ãƒªãƒ¢ãƒ¼ãƒˆè¿½åŠ ï¼ˆoriginã§ã¯ãªãdestinationã¨ã—ã¦è¿½åŠ ï¼‰
          git remote add destination "$DEST_REPO"
          
          # æƒ…å ±è¡¨ç¤º
          echo "ğŸ“¦ Wikiãƒªãƒã‚¸ãƒˆãƒªã¸ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ã„ã¾ã™..."
          echo "   é€ä¿¡å…ˆ: $DEST_REPO"
          echo ""
          echo "ğŸ“‹ ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ãƒ–ãƒ©ãƒ³ãƒ:"
          git branch --list | sed 's/^/  - /'
          echo ""
          echo "ğŸ“‹ ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹ã‚¿ã‚°:"
          git tag --list | sed 's/^/  - /' || echo "  (ã‚¿ã‚°ãªã—)"
          echo ""
          
          # Pushå®Ÿè¡Œï¼ˆã™ã¹ã¦ã®ãƒ–ãƒ©ãƒ³ãƒã¨ã‚¿ã‚°ã‚’ãƒ—ãƒƒã‚·ãƒ¥ï¼‰
          # destination ã«ã—ã‹é€ã‚Œãªã„çŠ¶æ…‹ã«ãªã£ã¦ã„ã¾ã™
          git push --mirror --force destination
          
          echo "âœ… Wikiãƒªãƒã‚¸ãƒˆãƒªã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã«æˆåŠŸã—ã¾ã—ãŸ"

