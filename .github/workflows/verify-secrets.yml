name: リポジトリの機密情報検証

on:
  schedule:
    # 毎日 日本時間 12:30 (UTC 03:30) に実行
    - cron: '30 3 * * *'
  workflow_dispatch: # 手動実行用ボタン
  push:
    branches:
      - main
      - '**'

jobs:
  verify-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for sensitive files in working directory
        run: |
          echo "🔍 削除対象ファイルの存在確認中..."
          echo "   ※ ソースリポジトリでは存在しても問題ありませんが、Wikiリポジトリでは削除されている必要があります"
          
          DELETED_FILES=(
            ".env"
            ".env.local"
            ".env.production"
            ".env.backup"
            ".env.old"
            "env.development"
            ".docker.env"
            "auth.json"
            "config/secrets.json"
            "config/secrets.yaml"
            "config/remote.php"
            "certs/server.pem"
            "certs/client.key"
            "keys/api.p12"
            ".ssh/id_rsa"
            ".ssh/config"
            "temp-credentials.json"
            "config/api-keys.json"
          )
          
          # 機密情報を含む可能性のあるJSONファイルをパターンで検索
          JSON_PATTERNS=(
            "*credentials*.json"
            "*secrets*.json"
            "*keys*.json"
            "*secret*.json"
            "*password*.json"
            "*token*.json"
          )
          
          FOUND_FILES=()
          for file in "${DELETED_FILES[@]}"; do
            if [ -f "$file" ] || [ -d "$file" ]; then
              FOUND_FILES+=("$file")
            fi
          done
          
          # JSONファイルパターンの検索
          for pattern in "${JSON_PATTERNS[@]}"; do
            while IFS= read -r -d '' file; do
              FOUND_FILES+=("$file")
            done < <(find . -type f -name "$pattern" ! -path "./.git/*" ! -path "./node_modules/*" -print0 2>/dev/null)
          done
          
          if [ ${#FOUND_FILES[@]} -gt 0 ]; then
            echo "⚠️  警告: 削除対象ファイルが存在します:"
            printf '  - %s\n' "${FOUND_FILES[@]}"
            echo ""
            echo "   ※ ソースリポジトリの場合: 検証用プロジェクトのため、存在は正常です。"
            echo "   ※ Wikiリポジトリの場合: これらのファイルはサニタイズ処理で削除されている必要があります。"
          else
            echo "✅ 削除対象ファイルは存在しません"
          fi

      - name: Check for secrets in git history
        run: |
          echo "🔍 Git履歴に機密情報が残っていないか確認中..."
          
          # 機密情報のパターン（簡易的な検出）
          SECRET_PATTERNS=(
            "password.*=.*[a-zA-Z0-9]{8,}"
            "secret.*=.*[a-zA-Z0-9]{8,}"
            "api[_-]?key.*=.*[a-zA-Z0-9]{8,}"
            "token.*=.*[a-zA-Z0-9]{8,}"
            "-----BEGIN.*PRIVATE KEY-----"
            "-----BEGIN.*RSA PRIVATE KEY-----"
            "-----BEGIN OPENSSH PRIVATE KEY-----"
            "DATABASE_PASSWORD=.*"
            "JWT_SECRET=.*"
            "SECRET_KEY=.*"
          )
          
          # 除外するファイルパターン（ワークフロー、ドキュメント、設定ファイル）
          EXCLUDE_PATTERNS=(
            ".github/workflows/"
            "README.md"
            "SECURITY.md"
            "VALIDATION.md"
            ".gitignore"
            "*.md"
          )
          
          FOUND_SECRETS=()
          SECRET_DETAILS=()
          for pattern in "${SECRET_PATTERNS[@]}"; do
            # 履歴全体を検索（削除されたファイルも含む）
            # ワークフローファイルやドキュメントファイルを除外
            MATCHES=$(git log --all --full-history -p --source --all 2>/dev/null | \
              grep -vE '\.github/workflows/|README\.md|SECURITY\.md|VALIDATION\.md|\.gitignore' | \
              grep -iE "$pattern" 2>/dev/null || true)
            if [ -n "$MATCHES" ]; then
              FOUND_SECRETS+=("$pattern")
              # どのファイルに含まれているか確認（除外パターンを除く）
              FILES_WITH_PATTERN=$(git log --all --full-history --name-only --pretty=format: --source --all 2>/dev/null | \
                grep -vE '\.github/workflows/|README\.md|SECURITY\.md|VALIDATION\.md|\.gitignore' | \
                grep -v '^$' | sort -u | head -5)
              if [ -n "$FILES_WITH_PATTERN" ]; then
                SECRET_DETAILS+=("$pattern: $(echo "$FILES_WITH_PATTERN" | tr '\n' ', ' | sed 's/, $//')")
              fi
            fi
          done
          
          if [ ${#FOUND_SECRETS[@]} -gt 0 ]; then
            echo "⚠️  警告: 履歴に機密情報のパターンが見つかりました:"
            printf '  - %s\n' "${FOUND_SECRETS[@]}"
            echo ""
            if [ ${#SECRET_DETAILS[@]} -gt 0 ]; then
              echo "含まれている可能性のあるファイル:"
              printf '  - %s\n' "${SECRET_DETAILS[@]}"
              echo ""
            fi
            echo "詳細を確認するには以下を実行してください:"
            echo "  git log --all --full-history -p | grep -iE 'DATABASE_PASSWORD|JWT_SECRET|SECRET_KEY'"
            # 警告のみでエラーにはしない（パターンマッチングは誤検知の可能性があるため）
          else
            echo "✅ 履歴に機密情報のパターンは見つかりませんでした"
          fi

      - name: Check for deleted files in git history
        run: |
          echo "🔍 Git履歴に削除対象ファイルが残っているか確認中..."
          echo "   ※ ソースリポジトリでは履歴に残っていても問題ありませんが、Wikiリポジトリでは削除されている必要があります"
          
          DELETED_FILE_PATTERNS=(
            ".env"
            ".env.local"
            ".env.production"
            ".env.backup"
            ".env.old"
            "env.development"
            ".docker.env"
            "auth.json"
            "config/secrets"
            "config/remote.php"
            "*.pem"
            "*.key"
            "*.p12"
            ".ssh/id_rsa"
            "*credentials*.json"
            "*secrets*.json"
            "*keys*.json"
            "*secret*.json"
            "*password*.json"
            "*token*.json"
          )
          
          FOUND_IN_HISTORY=()
          for pattern in "${DELETED_FILE_PATTERNS[@]}"; do
            # 履歴内でファイルが存在したか確認
            if git log --all --full-history --name-only --pretty=format: -- "$pattern" 2>/dev/null | grep -q .; then
              FOUND_IN_HISTORY+=("$pattern")
            fi
          done
          
          if [ ${#FOUND_IN_HISTORY[@]} -gt 0 ]; then
            echo "⚠️  警告: 履歴に削除対象ファイルが見つかりました:"
            printf '  - %s\n' "${FOUND_IN_HISTORY[@]}"
            echo ""
            echo "   ※ ソースリポジトリの場合: 検証用プロジェクトのため、履歴に残っているのは正常です。"
            echo "   ※ Wikiリポジトリの場合: これらのファイルはサニタイズ処理で履歴からも削除されている必要があります。"
          else
            echo "✅ 履歴に削除対象ファイルは見つかりませんでした"
          fi

      - name: Check for hardcoded secrets in source code
        run: |
          echo "🔍 ソースコードにハードコーディングされた機密情報がないか確認中..."
          
          # ソースコードファイルのみをチェック（履歴は除外）
          SOURCE_FILES=$(find . -type f \( -name "*.js" -o -name "*.ts" -o -name "*.py" -o -name "*.php" -o -name "*.java" -o -name "*.rb" \) ! -path "./.git/*" ! -path "./node_modules/*")
          
          SUSPICIOUS_PATTERNS=(
            "password.*=.*['\"][^'\"]{8,}['\"]"
            "secret.*=.*['\"][^'\"]{8,}['\"]"
            "api[_-]?key.*=.*['\"][^'\"]{8,}['\"]"
            "token.*=.*['\"][^'\"]{8,}['\"]"
          )
          
          FOUND_HARDCODED=()
          for file in $SOURCE_FILES; do
            for pattern in "${SUSPICIOUS_PATTERNS[@]}"; do
              if grep -qiE "$pattern" "$file" 2>/dev/null; then
                FOUND_HARDCODED+=("$file: $pattern")
              fi
            done
          done
          
          if [ ${#FOUND_HARDCODED[@]} -gt 0 ]; then
            echo "⚠️  警告: ソースコードにハードコーディングされた可能性のある機密情報が見つかりました:"
            printf '  - %s\n' "${FOUND_HARDCODED[@]}"
            echo ""
            echo "これらは誤検知の可能性があります。コードを確認してください。"
            # 警告のみでエラーにはしない
          else
            echo "✅ ソースコードにハードコーディングされた機密情報は見つかりませんでした"
          fi

      - name: Summary
        run: |
          echo ""
          echo "=========================================="
          echo "✅ 機密情報検証が完了しました"
          echo "=========================================="
          echo ""
          echo "検証項目:"
          echo "  ✅ 削除対象ファイルの存在確認"
          echo "  ✅ Git履歴の確認"
          echo "  ✅ ソースコードの確認"
          echo ""
          echo "注意:"
          echo "  - ソースリポジトリの場合: 検証用プロジェクトのため、"
          echo "    機密情報が含まれているのは正常です。"
          echo "  - Wikiリポジトリの場合: サニタイズ処理により、"
          echo "    機密情報は削除されている必要があります。"

