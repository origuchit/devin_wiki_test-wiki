name: Verify Secrets Status (Source Repository)

on:
  schedule:
    # 毎日 日本時間 12:30 (UTC 03:30) に実行（サニタイズ処理の前）
    - cron: '30 3 * * *'
  workflow_dispatch: # 手動実行用ボタン
  push:
    branches:
      - main
      - '**'

jobs:
  verify-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for sensitive files in working directory
        run: |
          echo "🔍 削除対象ファイルの存在確認中（検証用プロジェクトのため、存在は正常です）..."
          
          DELETED_FILES=(
            ".env"
            ".env.local"
            ".env.production"
            ".env.backup"
            ".env.old"
            "env.development"
            ".docker.env"
            "auth.json"
            "config/secrets.json"
            "config/secrets.yaml"
            "config/remote.php"
            "certs/server.pem"
            "certs/client.key"
            "keys/api.p12"
            ".ssh/id_rsa"
            ".ssh/config"
            "temp-credentials.json"
            "config/api-keys.json"
          )
          
          FOUND_FILES=()
          for file in "${DELETED_FILES[@]}"; do
            if [ -f "$file" ] || [ -d "$file" ]; then
              FOUND_FILES+=("$file")
            fi
          done
          
          if [ ${#FOUND_FILES[@]} -gt 0 ]; then
            echo "⚠️  注意: 削除対象ファイルが存在します（検証用プロジェクトのため正常）:"
            printf '  - %s\n' "${FOUND_FILES[@]}"
            echo ""
            echo "これらのファイルはサニタイズ処理で削除されます。"
          else
            echo "✅ 削除対象ファイルは存在しません"

      - name: Check for secrets in git history
        run: |
          echo "🔍 Git履歴に機密情報が残っていないか確認中..."
          
          # 機密情報のパターン（簡易的な検出）
          SECRET_PATTERNS=(
            "password.*=.*[a-zA-Z0-9]{8,}"
            "secret.*=.*[a-zA-Z0-9]{8,}"
            "api[_-]?key.*=.*[a-zA-Z0-9]{8,}"
            "token.*=.*[a-zA-Z0-9]{8,}"
            "-----BEGIN.*PRIVATE KEY-----"
            "-----BEGIN.*RSA PRIVATE KEY-----"
            "-----BEGIN OPENSSH PRIVATE KEY-----"
            "DATABASE_PASSWORD=.*"
            "JWT_SECRET=.*"
            "SECRET_KEY=.*"
          )
          
          FOUND_SECRETS=()
          for pattern in "${SECRET_PATTERNS[@]}"; do
            # 履歴全体を検索（削除されたファイルも含む）
            MATCHES=$(git log --all --full-history -p -S "$pattern" --source --all 2>/dev/null | grep -i "$pattern" || true)
            if [ -n "$MATCHES" ]; then
              FOUND_SECRETS+=("$pattern")
            fi
          done
          
          if [ ${#FOUND_SECRETS[@]} -gt 0 ]; then
            echo "⚠️  警告: 履歴に機密情報のパターンが見つかりました:"
            printf '  - %s\n' "${FOUND_SECRETS[@]}"
            echo ""
            echo "詳細を確認するには以下を実行してください:"
            echo "  git log --all --full-history -p | grep -i 'pattern'"
            # 警告のみでエラーにはしない（パターンマッチングは誤検知の可能性があるため）
          else
            echo "✅ 履歴に機密情報のパターンは見つかりませんでした"

      - name: Check for deleted files in git history
        run: |
          echo "🔍 Git履歴に削除対象ファイルが残っているか確認中（検証用プロジェクトのため、存在は正常です）..."
          
          DELETED_FILE_PATTERNS=(
            ".env"
            ".env.local"
            ".env.production"
            ".env.backup"
            ".env.old"
            "env.development"
            ".docker.env"
            "auth.json"
            "config/secrets"
            "config/remote.php"
            "*.pem"
            "*.key"
            "*.p12"
            ".ssh/id_rsa"
            "temp-credentials.json"
            "config/api-keys.json"
          )
          
          FOUND_IN_HISTORY=()
          for pattern in "${DELETED_FILE_PATTERNS[@]}"; do
            # 履歴内でファイルが存在したか確認
            if git log --all --full-history --name-only --pretty=format: -- "$pattern" 2>/dev/null | grep -q .; then
              FOUND_IN_HISTORY+=("$pattern")
            fi
          done
          
          if [ ${#FOUND_IN_HISTORY[@]} -gt 0 ]; then
            echo "⚠️  注意: 履歴に削除対象ファイルが見つかりました（検証用プロジェクトのため正常）:"
            printf '  - %s\n' "${FOUND_IN_HISTORY[@]}"
            echo ""
            echo "これらのファイルはサニタイズ処理で履歴からも削除されます。"
          else
            echo "✅ 履歴に削除対象ファイルは見つかりませんでした"

      - name: Check for hardcoded secrets in source code
        run: |
          echo "🔍 ソースコードにハードコーディングされた機密情報がないか確認中..."
          
          # ソースコードファイルのみをチェック（履歴は除外）
          SOURCE_FILES=$(find . -type f \( -name "*.js" -o -name "*.ts" -o -name "*.py" -o -name "*.php" -o -name "*.java" -o -name "*.rb" \) ! -path "./.git/*" ! -path "./node_modules/*")
          
          SUSPICIOUS_PATTERNS=(
            "password.*=.*['\"][^'\"]{8,}['\"]"
            "secret.*=.*['\"][^'\"]{8,}['\"]"
            "api[_-]?key.*=.*['\"][^'\"]{8,}['\"]"
            "token.*=.*['\"][^'\"]{8,}['\"]"
          )
          
          FOUND_HARDCODED=()
          for file in $SOURCE_FILES; do
            for pattern in "${SUSPICIOUS_PATTERNS[@]}"; do
              if grep -qiE "$pattern" "$file" 2>/dev/null; then
                FOUND_HARDCODED+=("$file: $pattern")
              fi
            done
          done
          
          if [ ${#FOUND_HARDCODED[@]} -gt 0 ]; then
            echo "⚠️  警告: ソースコードにハードコーディングされた可能性のある機密情報が見つかりました:"
            printf '  - %s\n' "${FOUND_HARDCODED[@]}"
            echo ""
            echo "これらは誤検知の可能性があります。コードを確認してください。"
            # 警告のみでエラーにはしない
          else
            echo "✅ ソースコードにハードコーディングされた機密情報は見つかりませんでした"

      - name: Summary
        run: |
          echo ""
          echo "=========================================="
          echo "✅ 機密情報検証が完了しました（ソースリポジトリ）"
          echo "=========================================="
          echo ""
          echo "検証項目:"
          echo "  ✅ 削除対象ファイルの存在確認"
          echo "  ✅ Git履歴の確認"
          echo "  ✅ ソースコードの確認"
          echo ""
          echo "注意: このリポジトリは検証用プロジェクトのため、"
          echo "機密情報が含まれているのは正常です。"
          echo "サニタイズ処理により、Wikiリポジトリからは削除されます。"

