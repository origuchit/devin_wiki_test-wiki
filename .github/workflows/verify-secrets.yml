name: Verify No Secrets in Repository

on:
  schedule:
    # æ¯æ—¥ æ—¥æœ¬æ™‚é–“ 12:30 (UTC 03:30) ã«å®Ÿè¡Œ
    - cron: '30 3 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œç”¨ãƒœã‚¿ãƒ³
  push:
    branches:
      - main
      - '**'

jobs:
  verify-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for sensitive files in working directory
        run: |
          echo "ğŸ” å‰Šé™¤å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªä¸­..."
          echo "   â€» ã‚½ãƒ¼ã‚¹ãƒªãƒã‚¸ãƒˆãƒªã§ã¯å­˜åœ¨ã—ã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ãŒã€Wikiãƒªãƒã‚¸ãƒˆãƒªã§ã¯å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"
          
          DELETED_FILES=(
            ".env"
            ".env.local"
            ".env.production"
            ".env.backup"
            ".env.old"
            "env.development"
            ".docker.env"
            "auth.json"
            "config/secrets.json"
            "config/secrets.yaml"
            "config/remote.php"
            "certs/server.pem"
            "certs/client.key"
            "keys/api.p12"
            ".ssh/id_rsa"
            ".ssh/config"
            "temp-credentials.json"
            "config/api-keys.json"
          )
          
          # æ©Ÿå¯†æƒ…å ±ã‚’å«ã‚€å¯èƒ½æ€§ã®ã‚ã‚‹JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‘ã‚¿ãƒ¼ãƒ³ã§æ¤œç´¢
          JSON_PATTERNS=(
            "*credentials*.json"
            "*secrets*.json"
            "*keys*.json"
            "*secret*.json"
            "*password*.json"
            "*token*.json"
          )
          
          FOUND_FILES=()
          for file in "${DELETED_FILES[@]}"; do
            if [ -f "$file" ] || [ -d "$file" ]; then
              FOUND_FILES+=("$file")
            fi
          done
          
          # JSONãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œç´¢
          for pattern in "${JSON_PATTERNS[@]}"; do
            while IFS= read -r -d '' file; do
              FOUND_FILES+=("$file")
            done < <(find . -type f -name "$pattern" ! -path "./.git/*" ! -path "./node_modules/*" -print0 2>/dev/null)
          done
          
          if [ ${#FOUND_FILES[@]} -gt 0 ]; then
            echo "âš ï¸  è­¦å‘Š: å‰Šé™¤å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™:"
            printf '  - %s\n' "${FOUND_FILES[@]}"
            echo ""
            echo "   â€» ã‚½ãƒ¼ã‚¹ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ: æ¤œè¨¼ç”¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãŸã‚ã€å­˜åœ¨ã¯æ­£å¸¸ã§ã™ã€‚"
            echo "   â€» Wikiãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ: ã“ã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚µãƒ‹ã‚¿ã‚¤ã‚ºå‡¦ç†ã§å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚"
          else
            echo "âœ… å‰Šé™¤å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã¯å­˜åœ¨ã—ã¾ã›ã‚“"
          fi

      - name: Check for secrets in git history
        run: |
          echo "ğŸ” Gitå±¥æ­´ã«æ©Ÿå¯†æƒ…å ±ãŒæ®‹ã£ã¦ã„ãªã„ã‹ç¢ºèªä¸­..."
          
          # æ©Ÿå¯†æƒ…å ±ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆç°¡æ˜“çš„ãªæ¤œå‡ºï¼‰
          SECRET_PATTERNS=(
            "password.*=.*[a-zA-Z0-9]{8,}"
            "secret.*=.*[a-zA-Z0-9]{8,}"
            "api[_-]?key.*=.*[a-zA-Z0-9]{8,}"
            "token.*=.*[a-zA-Z0-9]{8,}"
            "-----BEGIN.*PRIVATE KEY-----"
            "-----BEGIN.*RSA PRIVATE KEY-----"
            "-----BEGIN OPENSSH PRIVATE KEY-----"
            "DATABASE_PASSWORD=.*"
            "JWT_SECRET=.*"
            "SECRET_KEY=.*"
          )
          
          # é™¤å¤–ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
          EXCLUDE_PATTERNS=(
            ".github/workflows/"
            "README.md"
            "SECURITY.md"
            "VALIDATION.md"
            ".gitignore"
            "*.md"
          )
          
          FOUND_SECRETS=()
          SECRET_DETAILS=()
          for pattern in "${SECRET_PATTERNS[@]}"; do
            # å±¥æ­´å…¨ä½“ã‚’æ¤œç´¢ï¼ˆå‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚‚å«ã‚€ï¼‰
            # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–
            MATCHES=$(git log --all --full-history -p --source --all 2>/dev/null | \
              grep -vE '\.github/workflows/|README\.md|SECURITY\.md|VALIDATION\.md|\.gitignore' | \
              grep -iE "$pattern" 2>/dev/null || true)
            if [ -n "$MATCHES" ]; then
              FOUND_SECRETS+=("$pattern")
              # ã©ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªï¼ˆé™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é™¤ãï¼‰
              FILES_WITH_PATTERN=$(git log --all --full-history --name-only --pretty=format: --source --all 2>/dev/null | \
                grep -vE '\.github/workflows/|README\.md|SECURITY\.md|VALIDATION\.md|\.gitignore' | \
                grep -v '^$' | sort -u | head -5)
              if [ -n "$FILES_WITH_PATTERN" ]; then
                SECRET_DETAILS+=("$pattern: $(echo "$FILES_WITH_PATTERN" | tr '\n' ', ' | sed 's/, $//')")
              fi
            fi
          done
          
          if [ ${#FOUND_SECRETS[@]} -gt 0 ]; then
            echo "âš ï¸  è­¦å‘Š: å±¥æ­´ã«æ©Ÿå¯†æƒ…å ±ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:"
            printf '  - %s\n' "${FOUND_SECRETS[@]}"
            echo ""
            if [ ${#SECRET_DETAILS[@]} -gt 0 ]; then
              echo "å«ã¾ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«:"
              printf '  - %s\n' "${SECRET_DETAILS[@]}"
              echo ""
            fi
            echo "è©³ç´°ã‚’ç¢ºèªã™ã‚‹ã«ã¯ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„:"
            echo "  git log --all --full-history -p | grep -iE 'DATABASE_PASSWORD|JWT_SECRET|SECRET_KEY'"
            # è­¦å‘Šã®ã¿ã§ã‚¨ãƒ©ãƒ¼ã«ã¯ã—ãªã„ï¼ˆãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã¯èª¤æ¤œçŸ¥ã®å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ï¼‰
          else
            echo "âœ… å±¥æ­´ã«æ©Ÿå¯†æƒ…å ±ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          fi

      - name: Check for deleted files in git history
        run: |
          echo "ğŸ” Gitå±¥æ­´ã«å‰Šé™¤å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ®‹ã£ã¦ã„ã‚‹ã‹ç¢ºèªä¸­..."
          echo "   â€» ã‚½ãƒ¼ã‚¹ãƒªãƒã‚¸ãƒˆãƒªã§ã¯å±¥æ­´ã«æ®‹ã£ã¦ã„ã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ãŒã€Wikiãƒªãƒã‚¸ãƒˆãƒªã§ã¯å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™"
          
          DELETED_FILE_PATTERNS=(
            ".env"
            ".env.local"
            ".env.production"
            ".env.backup"
            ".env.old"
            "env.development"
            ".docker.env"
            "auth.json"
            "config/secrets"
            "config/remote.php"
            "*.pem"
            "*.key"
            "*.p12"
            ".ssh/id_rsa"
            "*credentials*.json"
            "*secrets*.json"
            "*keys*.json"
            "*secret*.json"
            "*password*.json"
            "*token*.json"
          )
          
          FOUND_IN_HISTORY=()
          for pattern in "${DELETED_FILE_PATTERNS[@]}"; do
            # å±¥æ­´å†…ã§ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãŸã‹ç¢ºèª
            if git log --all --full-history --name-only --pretty=format: -- "$pattern" 2>/dev/null | grep -q .; then
              FOUND_IN_HISTORY+=("$pattern")
            fi
          done
          
          if [ ${#FOUND_IN_HISTORY[@]} -gt 0 ]; then
            echo "âš ï¸  è­¦å‘Š: å±¥æ­´ã«å‰Šé™¤å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:"
            printf '  - %s\n' "${FOUND_IN_HISTORY[@]}"
            echo ""
            echo "   â€» ã‚½ãƒ¼ã‚¹ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ: æ¤œè¨¼ç”¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãŸã‚ã€å±¥æ­´ã«æ®‹ã£ã¦ã„ã‚‹ã®ã¯æ­£å¸¸ã§ã™ã€‚"
            echo "   â€» Wikiãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ: ã“ã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚µãƒ‹ã‚¿ã‚¤ã‚ºå‡¦ç†ã§å±¥æ­´ã‹ã‚‰ã‚‚å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚"
          else
            echo "âœ… å±¥æ­´ã«å‰Šé™¤å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          fi

      - name: Check for hardcoded secrets in source code
        run: |
          echo "ğŸ” ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚ŒãŸæ©Ÿå¯†æƒ…å ±ãŒãªã„ã‹ç¢ºèªä¸­..."
          
          # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆå±¥æ­´ã¯é™¤å¤–ï¼‰
          SOURCE_FILES=$(find . -type f \( -name "*.js" -o -name "*.ts" -o -name "*.py" -o -name "*.php" -o -name "*.java" -o -name "*.rb" \) ! -path "./.git/*" ! -path "./node_modules/*")
          
          SUSPICIOUS_PATTERNS=(
            "password.*=.*['\"][^'\"]{8,}['\"]"
            "secret.*=.*['\"][^'\"]{8,}['\"]"
            "api[_-]?key.*=.*['\"][^'\"]{8,}['\"]"
            "token.*=.*['\"][^'\"]{8,}['\"]"
          )
          
          FOUND_HARDCODED=()
          for file in $SOURCE_FILES; do
            for pattern in "${SUSPICIOUS_PATTERNS[@]}"; do
              if grep -qiE "$pattern" "$file" 2>/dev/null; then
                FOUND_HARDCODED+=("$file: $pattern")
              fi
            done
          done
          
          if [ ${#FOUND_HARDCODED[@]} -gt 0 ]; then
            echo "âš ï¸  è­¦å‘Š: ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚ŒãŸå¯èƒ½æ€§ã®ã‚ã‚‹æ©Ÿå¯†æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:"
            printf '  - %s\n' "${FOUND_HARDCODED[@]}"
            echo ""
            echo "ã“ã‚Œã‚‰ã¯èª¤æ¤œçŸ¥ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            # è­¦å‘Šã®ã¿ã§ã‚¨ãƒ©ãƒ¼ã«ã¯ã—ãªã„
          else
            echo "âœ… ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã•ã‚ŒãŸæ©Ÿå¯†æƒ…å ±ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          fi

      - name: Summary
        run: |
          echo ""
          echo "=========================================="
          echo "âœ… æ©Ÿå¯†æƒ…å ±æ¤œè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸ"
          echo "=========================================="
          echo ""
          echo "æ¤œè¨¼é …ç›®:"
          echo "  âœ… å‰Šé™¤å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª"
          echo "  âœ… Gitå±¥æ­´ã®ç¢ºèª"
          echo "  âœ… ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ç¢ºèª"
          echo ""
          echo "æ³¨æ„:"
          echo "  - ã‚½ãƒ¼ã‚¹ãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ: æ¤œè¨¼ç”¨ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãŸã‚ã€"
          echo "    æ©Ÿå¯†æƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã®ã¯æ­£å¸¸ã§ã™ã€‚"
          echo "  - Wikiãƒªãƒã‚¸ãƒˆãƒªã®å ´åˆ: ã‚µãƒ‹ã‚¿ã‚¤ã‚ºå‡¦ç†ã«ã‚ˆã‚Šã€"
          echo "    æ©Ÿå¯†æƒ…å ±ã¯å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚"

